// app/page.tsx
"use client";
// ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
import DownloadBtn from "../components/DownloadBtn";
import { useState, useCallback, useEffect, useRef } from "react";
import ReactFlow, {
  Background,
  Controls,
  applyEdgeChanges,
  applyNodeChanges,
  Node,
  Edge,
  NodeChange,
  EdgeChange,
  ConnectionLineType,
  MarkerType,
  Position,
} from "reactflow";
import "reactflow/dist/style.css";
import dagre from "dagre"; // ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á
import { parseSQL } from "../utils/sqlParser";


// SQL ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
const initialSql = `
CREATE TABLE public.users (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  email text UNIQUE NOT NULL,
  created_at timestamp
);

CREATE TABLE public.posts (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title text,
  user_id uuid REFERENCES public.users(id)
);
`;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î Layout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
const getLayoutedElements = (nodes: Node[], edges: Edge[]) => {
  const dagreGraph = new dagre.graphlib.Graph();
  dagreGraph.setDefaultEdgeLabel(() => ({}));

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á: 'LR' = ‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤ (Left to Right), 'TB' = ‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á (Top to Bottom)
  const direction = 'LR'; 
  dagreGraph.setGraph({ rankdir: direction, nodesep: 60, ranksep: 150 });

  nodes.forEach((node) => {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏¢ (Header 40px + 30px ‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß)
    // (‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô column ‡∏°‡∏≤‡∏à‡∏≤‡∏Å prop ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏≠‡∏ö‡πÅ‡∏õ‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data)
    const colCount = (node.data as any).columnCount || 5;
    dagreGraph.setNode(node.id, { width: 220, height: 40 + (colCount * 30) });
  });

  edges.forEach((edge) => {
    dagreGraph.setEdge(edge.source, edge.target);
  });

  dagre.layout(dagreGraph);

  const layoutedNodes = nodes.map((node) => {
    const nodeWithPosition = dagreGraph.node(node.id);
    return {
      ...node,
      targetPosition: direction === 'LR' ? Position.Left : Position.Top,
      sourcePosition: direction === 'LR' ? Position.Right : Position.Bottom,
      position: {
        x: nodeWithPosition.x - 110, // ‡∏õ‡∏£‡∏±‡∏ö Center
        y: nodeWithPosition.y - (nodeWithPosition.height / 2),
      },
    };
  });

  return { nodes: layoutedNodes, edges };
};

export default function Home() {
  const [sqlInput, setSqlInput] = useState(initialSql);
  const [nodes, setNodes] = useState<Node[]>([]);
  const [edges, setEdges] = useState<Edge[]>([]);

  // --- Logic ‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢ Sidebar ---
  const [sidebarWidth, setSidebarWidth] = useState(400);
  const [isResizing, setIsResizing] = useState(false);
  const sidebarRef = useRef<HTMLDivElement>(null);

  const startResizing = useCallback(() => setIsResizing(true), []);
  const stopResizing = useCallback(() => setIsResizing(false), []);
  const resize = useCallback((mouseMoveEvent: MouseEvent) => {
    if (isResizing) {
      setSidebarWidth(Math.max(200, Math.min(800, mouseMoveEvent.clientX)));
    }
  }, [isResizing]);

  useEffect(() => {
    window.addEventListener("mousemove", resize);
    window.addEventListener("mouseup", stopResizing);
    return () => window.removeEventListener("mousemove", resize);
  }, [resize, stopResizing]);
  // ---------------------------

  const onNodesChange = useCallback(
    (changes: NodeChange[]) => setNodes((nds) => applyNodeChanges(changes, nds)),
    []
  );
  const onEdgesChange = useCallback(
    (changes: EdgeChange[]) => setEdges((eds) => applyEdgeChanges(changes, eds)),
    []
  );

  const handleGenerate = () => {
    const { tables, edges: rels } = parseSQL(sqlInput);

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Node ‡πÅ‡∏ö‡∏ö UI ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö (HTML ‡πÉ‡∏ô Label)
    const initialNodes: Node[] = tables.map((t) => ({
      id: t.id,
      type: 'default', // ‡πÉ‡∏ä‡πâ Node ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Custom Component
      data: { 
        columnCount: t.columns.length, // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Layout
        label: (
          // UI ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö
          <div className="border border-gray-300 rounded-md shadow-sm bg-white min-w-[200px] overflow-hidden">
            {/* Header */}
            <div className="bg-gray-100 p-2 font-bold text-center border-b border-gray-200 text-gray-700">
              {t.id}
            </div>
            {/* Body */}
            <div className="p-2 text-sm text-gray-600 bg-white">
              {t.columns.map((c) => (
                <div key={c.name} className="flex justify-between py-1 border-b border-gray-50 last:border-0">
                  <span className={`flex items-center gap-1 ${c.isPk ? "text-blue-600 font-semibold" : ""}`}>
                    {c.isPk && "üîë"} {c.name}
                  </span>
                  <span className="text-gray-400 text-xs ml-2 font-mono">{c.type}</span>
                </div>
              ))}
            </div>
          </div>
        )
      },
      position: { x: 0, y: 0 } // ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß Dagre ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ
    }));

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° (Edges)
    const initialEdges: Edge[] = rels.map((r, i) => ({
      id: `e-${i}`,
      source: r.source,
      target: r.target,
      animated: true,
      type: 'smoothstep', // ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏±‡∏Å‡∏°‡∏∏‡∏°‡∏™‡∏ß‡∏¢‡πÜ
      style: { stroke: '#64748b', strokeWidth: 1.5 },
      markerEnd: {
        type: MarkerType.ArrowClosed,
        color: '#64748b',
      },
    }));

    // 3. ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Dagre
    const layouted = getLayoutedElements(initialNodes, initialEdges);

    setNodes(layouted.nodes);
    setEdges(layouted.edges);
  };

  return (
    <main className={`flex h-screen w-screen bg-gray-50 overflow-hidden ${isResizing ? 'cursor-col-resize select-none' : ''}`}>
      
      {/* Sidebar */}
      <div 
        ref={sidebarRef}
        style={{ width: sidebarWidth }}
        className="flex flex-col border-r bg-white shadow-lg z-10 flex-shrink-0"
      >
        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
           <h1 className="font-bold text-gray-700">SQL Diagram</h1>
           <button 
             onClick={handleGenerate} 
             className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md text-sm font-medium transition-colors shadow-sm"
           >
             Generate
           </button>
        </div>
        
        <div className="flex-1 relative">
          <textarea
            className="w-full h-full p-4 font-mono text-xs md:text-sm bg-[#1e1e1e] text-green-400 resize-none focus:outline-none leading-relaxed"
            value={sqlInput}
            onChange={(e) => setSqlInput(e.target.value)}
            spellCheck={false}
            placeholder="Paste CREATE TABLE statements..."
          />
        </div>
      </div>

      {/* Resizer */}
      <div
        onMouseDown={startResizing}
        className="w-1.5 h-full bg-gray-200 hover:bg-blue-400 cursor-col-resize transition-colors z-20"
      />

      {/* Diagram Canvas */}
      <div className="flex-1 h-full bg-gray-50 relative">
        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          connectionLineType={ConnectionLineType.SmoothStep}
          fitView
        >
          <Background color="#cbd5e1" gap={20} size={1} />
          <Controls className="bg-white shadow-md border border-gray-200 rounded-lg" />
          <DownloadBtn /> 

        </ReactFlow>
      </div>
    </main>
  );
}